import{s as f}from"./index-CubMQrjb.js";import{b as Z,a as ee}from"./index-B7kpHtsI.js";import{a as W}from"./index-Bv36is8d.js";import{s as H}from"./index-BZDK8OqM.js";import{P as M,s as se,T as te}from"./repositorios-sGaJ6pbY.js";import{a2 as ae,E as _,_ as oe,a3 as ie,a4 as le,J as ne,K as re,r as ue,c as v,a as s,t as l,b as u,d as o,C as S,k as de,f as Q,F as ce,A as me,g as P,L as w,o as m,M as z,e as F}from"./index-D4yXbplw.js";import{u as pe}from"./categorias-CBZr8j9o.js";import"./index-DEf-bt_W.js";import"./index-Dd3LGBax.js";const ve=ae("presupuestos",()=>{const p=_([]),r=_(!1),y=_(null);async function N(i,c,g={}){r.value=!0,y.value=null;try{p.value=await M.conGastos(i,c,g)}catch(x){y.value=x.message}finally{r.value=!1}}async function b(i){const c=await M.crear(i);return p.value.unshift({...c,gastado:0,pct:0}),c}async function D(i,c){const g=await M.actualizar(i,c),x=p.value.findIndex(L=>L._id===i);return x!==-1&&(p.value[x]={...p.value[x],...g}),g}async function d(i){await M.eliminar(i),p.value=p.value.filter(c=>c._id!==i)}return{presupuestos:p,cargando:r,error:y,cargar:N,crear:b,actualizar:D,eliminar:d}}),ge={class:"page-header"},fe={class:"page-subtitle"},_e={class:"header-actions"},ye={class:"mes-nav"},be={class:"mes-label"},xe={class:"resumen-grid"},Ce={class:"card resumen-card"},we={class:"resumen-value text-primary"},ke={class:"card resumen-card"},$e={class:"resumen-value text-danger"},Ve={class:"card resumen-card"},he={class:"card resumen-card"},Se={class:"resumen-value"},ze={key:1,class:"empty-state card"},De={key:2,class:"presupuestos-lista"},Ee={class:"pres-header"},Me={class:"pres-cat"},Pe={class:"pres-nombre"},Fe={class:"pres-dates text-muted"},Ne={class:"pres-actions"},Le={class:"pres-progress-wrap"},Ae={class:"pres-bar-bg"},Be={class:"pres-montos"},Te={class:"pres-monto-item"},Ge={class:"text-danger",style:{"font-weight":"700"}},Ue={class:"pres-monto-item"},je={style:{"font-weight":"700"}},Oe={class:"pres-monto-item"},Je={key:0,class:"pres-alerta pres-alerta--danger"},qe={key:1,class:"pres-alerta pres-alerta--warn"},Ie={class:"dialog-body"},Ye={class:"field"},Ke={class:"cat-opt"},We={key:0,class:"cat-opt"},He={key:1,class:"text-muted"},Qe={class:"field"},Re={class:"field-row"},Xe={class:"field"},Ze={class:"field"},es={__name:"PresupuestosView",setup(p){const r=ve(),y=pe(),N=ie(),b=le(),D=new Date,d=_(D.getMonth()+1),i=_(D.getFullYear()),c=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],g=w(()=>c[d.value-1]),x=w(()=>d.value===new Date().getMonth()+1&&i.value===new Date().getFullYear()),L=c.map((a,e)=>({label:a,value:e+1}));function O(a){let e=d.value+a,t=i.value;e>12&&(e=1,t++),e<1&&(e=12,t--),d.value=e,i.value=t}async function A(){await y.cargar();const a=await te.listar(),e=`${i.value}-${String(d.value).padStart(2,"0")}`,t=a.filter(h=>{var E;return(E=h.fecha)==null?void 0:E.startsWith(e)}),V={};for(const h of t.filter(E=>E.tipo==="gasto"))V[h.categoria_id||"sin"]=(V[h.categoria_id||"sin"]||0)+(h.monto||0);await r.cargar(d.value,i.value,V)}ne(A),re([d,i],A);const J=w(()=>r.presupuestos.reduce((a,e)=>a+(e.monto_limite||0),0)),q=w(()=>r.presupuestos.reduce((a,e)=>a+(e.gastado||0),0)),I=w(()=>J.value-q.value),B=w(()=>Object.fromEntries(y.categorias.map(a=>[a._id,a]))),Y=a=>{var e;return((e=B.value[a])==null?void 0:e.icono)||"pi-tag"},T=a=>{var e;return((e=B.value[a])==null?void 0:e.color)||"#6366f1"},G=a=>{var e;return((e=B.value[a])==null?void 0:e.nombre)||"Sin categoría"},K=a=>a>=100?"var(--fc-danger)":a>=80?"var(--fc-warning)":"var(--fc-success)",k=_(!1),$=_(null),U=_(!1),n=ue({categoria_id:null,monto_limite:null,mes:d.value,anio:i.value});function j(a=null){$.value=(a==null?void 0:a._id)||null,Object.assign(n,{categoria_id:(a==null?void 0:a.categoria_id)||null,monto_limite:(a==null?void 0:a.monto_limite)||null,mes:(a==null?void 0:a.mes)||d.value,anio:(a==null?void 0:a.anio)||i.value}),k.value=!0}async function R(){if(!n.categoria_id||!n.monto_limite){b.add({severity:"warn",summary:"Campos requeridos",life:3e3});return}U.value=!0;try{$.value?(await r.actualizar($.value,{monto_limite:n.monto_limite}),b.add({severity:"success",summary:"Presupuesto actualizado",life:3e3})):(await r.crear({categoria_id:n.categoria_id,monto_limite:n.monto_limite,mes:n.mes,anio:n.anio}),b.add({severity:"success",summary:"Presupuesto creado",life:3e3})),k.value=!1,await A()}catch(a){b.add({severity:"error",summary:"Error",detail:a.message,life:4e3})}finally{U.value=!1}}function X(a){N.require({message:`¿Eliminar el presupuesto de "${G(a.categoria_id)}"?`,header:"Confirmar eliminación",icon:"pi pi-trash",rejectLabel:"Cancelar",acceptLabel:"Eliminar",acceptClass:"p-button-danger",accept:async()=>{await r.eliminar(a._id),b.add({severity:"success",summary:"Eliminado",life:3e3})}})}const C=a=>a!==void 0?`S/ ${Number(a).toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2})}`:"S/ 0.00";return(a,e)=>(m(),v("div",null,[s("div",ge,[s("div",null,[e[10]||(e[10]=s("h1",{class:"page-title"},"Presupuestos",-1)),s("p",fe,"Control de gastos por categoría · "+l(g.value)+" "+l(i.value),1)]),s("div",_e,[s("div",ye,[u(o(f),{icon:"pi pi-chevron-left",text:"",rounded:"",onClick:e[0]||(e[0]=t=>O(-1))}),s("span",be,l(g.value)+" "+l(i.value),1),u(o(f),{icon:"pi pi-chevron-right",text:"",rounded:"",onClick:e[1]||(e[1]=t=>O(1)),disabled:x.value},null,8,["disabled"])]),u(o(f),{label:"Nuevo presupuesto",icon:"pi pi-plus",onClick:e[2]||(e[2]=t=>j())})])]),s("div",xe,[s("div",Ce,[e[11]||(e[11]=s("span",{class:"text-muted",style:{"font-size":"0.75rem"}},"Total presupuestado",-1)),s("span",we,l(C(J.value)),1)]),s("div",ke,[e[12]||(e[12]=s("span",{class:"text-muted",style:{"font-size":"0.75rem"}},"Total gastado",-1)),s("span",$e,l(C(q.value)),1)]),s("div",Ve,[e[13]||(e[13]=s("span",{class:"text-muted",style:{"font-size":"0.75rem"}},"Disponible",-1)),s("span",{class:S(["resumen-value",I.value>=0?"text-success":"text-danger"])},l(C(I.value)),3)]),s("div",he,[e[14]||(e[14]=s("span",{class:"text-muted",style:{"font-size":"0.75rem"}},"Categorías",-1)),s("span",Se,l(o(r).presupuestos.length),1)])]),o(r).cargando?(m(),de(o(se),{key:0})):Q("",!0),!o(r).cargando&&o(r).presupuestos.length===0?(m(),v("div",ze,[e[15]||(e[15]=s("i",{class:"pi pi-chart-bar",style:{"font-size":"2.5rem",opacity:"0.3",color:"var(--fc-primary)"}},null,-1)),e[16]||(e[16]=s("p",null,"Sin presupuestos para este mes",-1)),u(o(f),{label:"Crear el primero",icon:"pi pi-plus",outlined:"",onClick:e[3]||(e[3]=t=>j())})])):(m(),v("div",De,[(m(!0),v(ce,null,me(o(r).presupuestos,t=>(m(),v("div",{key:t._id,class:"card presupuesto-card"},[s("div",Ee,[s("div",Me,[s("div",{class:"cat-icon",style:z(`background:${T(t.categoria_id)}22;color:${T(t.categoria_id)}`)},[s("i",{class:S(["pi",Y(t.categoria_id)])},null,2)],4),s("div",null,[s("span",Pe,l(G(t.categoria_id)),1),s("span",Fe,l(g.value)+" "+l(i.value),1)])]),s("div",Ne,[u(o(f),{icon:"pi pi-pencil",text:"",rounded:"",size:"small",onClick:V=>j(t)},null,8,["onClick"]),u(o(f),{icon:"pi pi-trash",text:"",rounded:"",size:"small",severity:"danger",onClick:V=>X(t)},null,8,["onClick"])])]),s("div",Le,[s("div",Ae,[s("div",{class:"pres-bar-fill",style:z(`width:${t.pct}%;background:${K(t.pct)}`)},null,4)]),s("span",{class:"pres-pct",style:z(`color:${K(t.pct)}`)},l(t.pct)+"%",5)]),s("div",Be,[s("div",Te,[e[17]||(e[17]=s("span",{class:"text-muted"},"Gastado",-1)),s("span",Ge,l(C(t.gastado)),1)]),e[20]||(e[20]=s("div",{class:"pres-monto-item pres-monto-center"},[s("span",{class:"text-muted"},"de")],-1)),s("div",Ue,[e[18]||(e[18]=s("span",{class:"text-muted"},"Límite",-1)),s("span",je,l(C(t.monto_limite)),1)]),s("div",Oe,[e[19]||(e[19]=s("span",{class:"text-muted"},"Disponible",-1)),s("span",{class:S(t.monto_limite-t.gastado>=0?"text-success":"text-danger"),style:{"font-weight":"700"}},l(C(t.monto_limite-t.gastado)),3)])]),t.pct>=100?(m(),v("div",Je,[...e[21]||(e[21]=[s("i",{class:"pi pi-exclamation-triangle"},null,-1),F(" Presupuesto superado ",-1)])])):t.pct>=80?(m(),v("div",qe,[...e[22]||(e[22]=[s("i",{class:"pi pi-exclamation-circle"},null,-1),F(" Estás cerca del límite ",-1)])])):Q("",!0)]))),128))])),u(o(Z),{visible:k.value,"onUpdate:visible":e[9]||(e[9]=t=>k.value=t),header:$.value?"Editar presupuesto":"Nuevo presupuesto",modal:"",closable:!0,style:{width:"420px"}},{footer:P(()=>[u(o(f),{label:"Cancelar",text:"",onClick:e[8]||(e[8]=t=>k.value=!1)}),u(o(f),{label:$.value?"Actualizar":"Guardar",icon:"pi pi-check",loading:U.value,onClick:R},null,8,["label","loading"])]),default:P(()=>[s("div",Ie,[s("div",Ye,[e[23]||(e[23]=s("label",null,"Categoría de gasto *",-1)),u(o(W),{modelValue:n.categoria_id,"onUpdate:modelValue":e[4]||(e[4]=t=>n.categoria_id=t),options:o(y).gastoCats,optionValue:"_id",placeholder:"Selecciona una categoría",fluid:""},{option:P(({option:t})=>[s("div",Ke,[s("span",{style:z(`color:${t.color};margin-right:0.4rem`)},[s("i",{class:S(["pi",t.icono])},null,2)],4),F(" "+l(t.nombre),1)])]),value:P(({value:t})=>[t?(m(),v("div",We,[s("span",{style:z(`color:${T(t)};margin-right:0.4rem`)},[s("i",{class:S(["pi",Y(t)])},null,2)],4),F(" "+l(G(t)),1)])):(m(),v("span",He,"Selecciona una categoría"))]),_:1},8,["modelValue","options"])]),s("div",Qe,[e[24]||(e[24]=s("label",null,"Límite mensual (S/) *",-1)),u(o(H),{modelValue:n.monto_limite,"onUpdate:modelValue":e[5]||(e[5]=t=>n.monto_limite=t),min:1,minFractionDigits:2,maxFractionDigits:2,placeholder:"0.00",fluid:""},null,8,["modelValue"])]),s("div",Re,[s("div",Xe,[e[25]||(e[25]=s("label",null,"Mes",-1)),u(o(W),{modelValue:n.mes,"onUpdate:modelValue":e[6]||(e[6]=t=>n.mes=t),options:o(L),optionLabel:"label",optionValue:"value",fluid:""},null,8,["modelValue","options"])]),s("div",Ze,[e[26]||(e[26]=s("label",null,"Año",-1)),u(o(H),{modelValue:n.anio,"onUpdate:modelValue":e[7]||(e[7]=t=>n.anio=t),min:2020,max:2030,useGrouping:!1,fluid:""},null,8,["modelValue"])])])])]),_:1},8,["visible","header"]),u(o(ee))]))}},ds=oe(es,[["__scopeId","data-v-e7a2a87a"]]);export{ds as default};
